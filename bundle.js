(()=>{"use strict";window.util={setDisable:function(e,t){for(const n of t)n.disabled=e;return t},uploadImg:function(e,t,n){const o=e.files[0],i=o.name.toLowerCase();if(n.some((function(e){return i.endsWith(e)}))){const e=new FileReader;e.addEventListener("load",(function(){t.src=e.result})),e.readAsDataURL(o)}}},(()=>{const e=document.querySelector(".map"),t=e.querySelector(".map__pins"),n=document.querySelectorAll("fieldset"),o=document.querySelector(".map__filters"),i=document.querySelector("#pin").content.querySelector(".map__pin");let a,r=0;const d=function(e){a=i.cloneNode(!0),a.setAttribute("style",`left: ${e.location.x+25}px; top: ${e.location.y+70}px`);const t=a.querySelector("img");return t.src=e.author.avatar,t.alt=e.offer.title,a.dataset.value=r,r++,a.addEventListener("click",window.map.iconClick),a.addEventListener("keydown",c),a},c=function(e){"Enter"===e.key&&(window.map.iconClick(),a.removeEventListener("keydown",c))};window.pin={createPins:function(e){const n=document.createDocumentFragment();for(let t=0;t<e.length;t++)n.appendChild(d(e[t]));t.appendChild(n)},remove:function(){const e=window.pin.mapAds.querySelectorAll(".map__pin"),t=window.pin.map.querySelector(".map__card");for(let t=0;t<e.length;t++)e[t].classList.contains("map__pin--main")||e[t].remove();t&&t.remove(),r=0},width:50,height:70,mainWidth:62,mainHeight:84,fieldset:n,filter:o,map:e,maxSimilar:5,mapAds:t}})(),(()=>{const e={flat:"Квартира",bungalow:"Бунгало",house:"Дом",palace:"Дворец"},t=document.querySelector("#card").content.querySelector(".popup");let n;window.card={create:function(o){const i=t.cloneNode(!0),a=i.querySelector(".popup__features"),r=i.querySelector(".popup__photos"),d=i.querySelector(".popup__description");return i.querySelector(".popup__title").textContent=o.offer.title,i.querySelector(".popup__text--address").textContent=o.offer.address,i.querySelector(".popup__text--price").textContent=o.offer.price+" ₽/ночь",i.querySelector(".popup__type").textContent=e[o.offer.type],i.querySelector(".popup__text--capacity").textContent=`${o.offer.rooms} комнаты для ${o.offer.guests} гостей`,i.querySelector(".popup__text--time").textContent=`Заезд после ${o.offer.checkin}, выезд до ${o.offer.checkout}`,0===o.offer.features.length?a.remove():function(e,t){for(;e.firstChild;)e.removeChild(e.firstChild);for(let n=0;n<t.offer.features.length;n++){const o=document.createElement("li");o.classList.add("popup__feature"),o.classList.add("popup__feature--"+t.offer.features[n]),e.appendChild(o)}}(a,o),""===o.offer.description?d.remove():d.textContent=o.offer.description,0===o.offer.photos.length?r.remove():function(e,t){for(let n=0;n<t.offer.photos.length;n++){const o=e.querySelector("img").cloneNode(!1);o.src=t.offer.photos[n],e.appendChild(o)}e.querySelector("img").remove()}(r,o),i.querySelector(".popup__avatar").src=o.author.avatar,i.dataset.value=n,i},attribute:function(e){n=e},closed:function(){const e=window.pin.map.querySelector(".map__card");e&&window.pin.map.removeChild(e)}}})(),(()=>{const e=function(e,t){const n=new XMLHttpRequest;return n.responseType="json",n.addEventListener("load",(function(){switch(n.status){case 200:e(n.response);break;case 404:t("Запрашиваемый ресурс не найден");break;case 403:t("Отсутствует доступ к ресурсу");break;default:t(`Cтатус ответа: ${n.status} - ${n.statusText};`)}})),n.addEventListener("error",(function(){t("Произошла ошибка соединения")})),n.addEventListener("timeout",(function(){t(`Запрос не успел выполниться за ${n.timeout} мс`)})),n.timeout=1e4,n};window.server={load:function(t,n){const o=e(t,n);o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()},upload:function(t,n,o){const i=e(n,o);i.open("POST","https://21.javascript.pages.academy/keksobooking"),i.send(t)},errorHandler:function(e){const t=document.createElement("div");t.style="z-index: 100; margin: 0 auto; text-align: center; background-color: rgba(255,255,255,0.9)",t.style.border="3px solid rgba(255,0,0,0.8)",t.style.borderRadius="8px",t.style.width="650px",t.style.minHeight="80px",t.style.position="absolute",t.style.left=0,t.style.right=0,t.style.top="20%",t.style.fontSize="22px",t.style.lineHeight="30px",t.style.paddingTop="15px",t.textContent=e,document.body.insertAdjacentElement("afterbegin",t)}}})(),(()=>{const e=0-window.pin.mainWidth/2,t=1200-window.pin.mainWidth/2,n=130-window.pin.mainHeight,o=630-window.pin.mainHeight,i=document.querySelector(".map");window.dragging={mainPin:function(){const a=function(e,t){window.pageState.adress.value=`${Math.round(e+window.pin.mainWidth/2)}, ${Math.round(t+window.pin.mainHeight)}`};window.pageState.mainPin.addEventListener("mousedown",(function(r){r.preventDefault();let d={x:r.clientX,y:r.clientY};const c=function(i){i.preventDefault();const r=d.x-i.clientX,c=d.y-i.clientY,s={x:window.pageState.mainPin.offsetLeft-r,y:window.pageState.mainPin.offsetTop-c};s.x>=t&&(s.x=t),s.y>=o&&(s.y=o),s.x<=e&&(s.x=e),s.y<=n&&(s.y=n),parseInt(window.pageState.mainPin.style.left,10)!==s.x&&(d.x=i.clientX),parseInt(window.pageState.mainPin.style.top,10)!==s.y&&(d.y=i.clientY),window.pageState.mainPin.style.left=s.x+"px",window.pageState.mainPin.style.top=s.y+"px",a(s.x,s.y),window.dragging={coords:s}},s=function(e){e.preventDefault(),a(window.dragging.coords.x,window.dragging.coords.y),i.removeEventListener("mousemove",c),document.removeEventListener("mouseup",s)};i.addEventListener("mousemove",c),document.addEventListener("mouseup",s)}))}}})(),(()=>{const e=document.querySelector(".ad-form"),t=e.querySelector("#capacity"),n=e.querySelector("#address"),o=window.pin.map.querySelector(".map__pin--main"),i=function(){window.server.load(window.map.loading,window.server.errorHandler),window.pin.map.classList.remove("map--faded"),e.classList.remove("ad-form--disabled"),n.value=`${Math.round(o.offsetLeft+window.pin.mainWidth/2)}, ${Math.round(o.offsetTop+window.pin.mainHeight)}`,t.options[2].selected=!0},a=function(e){0===e.button&&(i(),o.removeEventListener("mousedown",a),o.removeEventListener("keydown",r),window.dragging.mainPin())},r=function(e){"Enter"===e.key&&(i(),o.removeEventListener("keydown",r),o.removeEventListener("mousedown",a))};window.pageState={blockPage:function(){window.util.setDisable(!0,window.pin.fieldset),window.util.setDisable(!0,window.pin.filter),n.value=`${o.offsetLeft}, ${o.offsetTop}`},activatePageMouse:a,activatePageEnter:r,ad:e,mainPin:o,adress:n,capacity:t}})(),(()=>{const e=window.pageState.ad.querySelector(".ad-form__field input[type=file]"),t=window.pageState.ad.querySelector(".ad-form-header__preview img"),n=window.pageState.ad.querySelector(".ad-form__upload input[type=file]"),o=window.pageState.ad.querySelector(".ad-form__photo"),i=["gif","jpg","jpeg","png"];e.addEventListener("change",(function(){window.util.uploadImg(e,t,i)})),n.addEventListener("change",(function(){const e=n.files[0],t=e.name.toLowerCase();if(i.some((function(e){return t.endsWith(e)}))){const t=new FileReader;t.addEventListener("load",(function(){if(0===o.children.length){const e=document.createElement("img");e.style.width="70px",e.style.height="70px",e.alt="Фотография жилья",e.src=t.result,o.appendChild(e)}else o.firstChild.src=t.result})),t.readAsDataURL(e)}})),window.uploadPhotos={reset:function(){const e=o.querySelector("img");e&&e.remove(),"img/muffin-grey.svg"!==window.uploadPhotos.avatar.src&&(window.uploadPhotos.avatar.src="img/muffin-grey.svg")},avatar:t}})(),(()=>{const e=window.pageState.ad.querySelector("#type"),t=window.pageState.ad.querySelector("#price"),n=window.pageState.ad.querySelector("#timein"),o=window.pageState.ad.querySelector("#timeout"),i=window.pageState.ad.querySelector("#room_number"),a=document.querySelectorAll("input[type=checkbox]"),r=document.querySelectorAll(".map__filters .map__filter"),d=function(){"bungalow"===e.value?(t.setAttribute("min",0),t.setAttribute("placeholder",0)):"flat"===e.value?(t.setAttribute("min",1e3),t.setAttribute("placeholder",1e3)):"house"===e.value?(t.setAttribute("min",5e3),t.setAttribute("placeholder",5e3)):"palace"===e.value&&(t.setAttribute("min",1e4),t.setAttribute("placeholder",1e4))},c=function(){window.pageState.ad.reset(),d(),a.forEach((function(e){e.checked&&(e.checked=!1)})),window.pageState.mainPin.style.left="570px",window.pageState.mainPin.style.top="375px";for(let e=0;e<r.length;e++)r[e].options[0].selected=!0;window.uploadPhotos.reset(),window.pin.remove(),window.pageState.blockPage(),window.pin.map.classList.add("map--faded"),window.pageState.ad.classList.add("ad-form--disabled"),window.pageState.mainPin.addEventListener("mousedown",window.pageState.activatePageMouse),window.pageState.mainPin.addEventListener("keydown",window.pageState.activatePageEnter),window.dragging.coords.x=window.pageState.mainPin.offsetLeft,window.dragging.coords.y=window.pageState.mainPin.offsetTop};window.form={changePrice:d,changeTime:function(e){n.value=e.target.value,o.value=e.target.value},changeGuest:function(){!function(){const e=i.selectedIndex,t=window.pageState.capacity.selectedIndex;return 0===e?2===t:1===e?1===t||2===t:2===e?0===t||1===t||2===t:3===e&&3===t}()?(i.setCustomValidity("Некорректное значение, проверти количество гостей"),window.pageState.capacity.setCustomValidity("Некорректное значение, количество гостей должно быть меньше или равно количеству комнат")):(i.setCustomValidity(""),window.pageState.capacity.setCustomValidity(""))},onResetButtonClick:function(e){e.preventDefault(),c()},resetFormAndMap:c,type:e,checkInTime:n,checkOutTime:o,rooms:i}})(),window.debounce={eliminate:function(e){const t=null;return function(...n){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...n)}),500)}}},(()=>{let e={type:"any",price:"any",rooms:"any",guests:"any",features:[]};window.filtration={check:function(t){let n=t.filter((function(t){return(t.offer.type===e.type||"any"===e.type)&&function(e,t){switch(e){case"low":return t<1e4;case"middle":return t>=1e4&&t<=5e4;case"high":return t>5e4;default:return"any"===e}}(e.price,t.offer.price)&&function(e,t){switch(e){case"1":return 1===t;case"2":return 2===t;case"3":return 3===t;default:return"any"===e}}(e.rooms,t.offer.rooms)&&function(e,t){switch(e){case"0":return 0===t;case"1":return 1===t;case"2":return 2===t;default:return"any"===e}}(e.guests,t.offer.guests)&&(function(t){const n=t.offer.features;for(let t=0;t<e.features.length;t++)if(o=t,n.indexOf(e.features[o])<0)return!1;var o;return!0}(t)||0===e.features.length)}));return n.length>window.pin.maxSimilar&&(n=n.slice(0,window.pin.maxSimilar)),n},enabled:e}})(),(()=>{const e=document.querySelector("main"),t=document.querySelector("#success").content.querySelector(".success"),n=document.querySelector("#error").content.querySelector(".error"),o=t.cloneNode(!0),i=n.cloneNode(!0),a=i.querySelector(".error__button"),r=function(){o&&e.removeChild(o),document.removeEventListener("keydown",d),document.removeEventListener("click",c)},d=function(e){"Escape"===e.key&&r()},c=function(){r()},s=function(){i&&e.removeChild(i),a.removeEventListener("keydown",l),document.removeEventListener("keydown",u),document.removeEventListener("click",w)},u=function(e){"Escape"===e.key&&s()},l=function(e){"Enter"===e.key&&s()},w=function(){s()};window.popup={uploadSuccess:function(){e.appendChild(o),document.addEventListener("keydown",d),document.addEventListener("click",c),window.form.resetFormAndMap()},uploadError:function(t){e.appendChild(i),i.querySelector(".error__message").textContent=t,a.addEventListener("keydown",l),document.addEventListener("keydown",u),document.addEventListener("click",w)}}})(),(()=>{const e=document.querySelectorAll("fieldset"),t=document.querySelector(".map__filters");let n,o;const i=window.debounce.eliminate((function(e){o=window.filtration.check(e),window.pin.remove(),window.pin.createPins(o)})),a=function(){const e=window.pin.mapAds.querySelector(".map__pin--active");e&&e.classList.remove("map__pin--active")};window.map={loading:function(o){if(n=o,n.length>window.pin.maxSimilar){let e=n.slice(0,window.pin.maxSimilar);window.pin.createPins(e)}else window.pin.createPins(n);window.util.setDisable(!1,t),window.util.setDisable(!1,e)},iconClick:function(e){const t=window.pin.map.querySelector(".map__filters-container"),i=window.pin.map.querySelector(".map__card"),r=e.currentTarget,d=e.currentTarget.dataset.value,c=Number(d);if(i&&i.dataset.value===d)return;var s;window.card.closed(),window.card.attribute(c),s=r,a(),s.classList.add("map__pin--active");const u=document.createDocumentFragment();void 0===o?u.appendChild(window.card.create(n[c])):u.appendChild(window.card.create(o[c])),window.pin.map.insertBefore(u,t);const l=window.pin.map.querySelector(".popup__close"),w=function(){window.card.closed(),a(),l.removeEventListener("click",w),l.removeEventListener("keydown",p),document.removeEventListener("keydown",m)},p=function(e){"Enter"===e.key&&(window.card.closed(),a(),l.removeEventListener("keydown",p),l.removeEventListener("click",w),document.removeEventListener("keydown",m))},m=function(e){"Escape"===e.key&&(window.card.closed(),a(),document.removeEventListener("keydown",m),l.removeEventListener("click",w),l.removeEventListener("keydown",p))};l.addEventListener("click",w),l.addEventListener("keydown",p),document.addEventListener("keydown",m)},changeHousingType:function(e){window.filtration.enabled.type=e.target.value},changePrice:function(e){window.filtration.enabled.price=e.target.value},changeRooms:function(e){window.filtration.enabled.rooms=e.target.value},changeGuests:function(e){window.filtration.enabled.guests=e.target.value},changeFeatures:function(e){if("map__checkbox visually-hidden"===e.target.className){const t=window.filtration.enabled.features.indexOf(e.target.value);e.target.checked?window.filtration.enabled.features.push(e.target.value):window.filtration.enabled.features.splice(t,1)}},changeFormDebounced:function(){i(n)},removeClassPin:a,filterForm:t}})(),(()=>{const e=window.pin.filter.querySelector("#housing-type"),t=window.pin.filter.querySelector("#housing-price"),n=window.pin.filter.querySelector("#housing-rooms"),o=window.pin.filter.querySelector("#housing-guests"),i=window.pin.filter.querySelector("#housing-features"),a=window.pageState.ad.querySelector(".ad-form__reset");window.pageState.blockPage(),window.pageState.mainPin.addEventListener("mousedown",window.pageState.activatePageMouse),window.pageState.mainPin.addEventListener("keydown",window.pageState.activatePageEnter),window.form.type.addEventListener("change",window.form.changePrice),window.form.checkInTime.addEventListener("change",window.form.changeTime),window.form.checkOutTime.addEventListener("change",window.form.changeTime),window.form.rooms.addEventListener("change",window.form.changeGuest),window.pageState.capacity.addEventListener("change",window.form.changeGuest),window.map.filterForm.addEventListener("change",window.map.changeFormDebounced),e.addEventListener("change",window.map.changeHousingType),t.addEventListener("change",window.map.changePrice),n.addEventListener("change",window.map.changeRooms),o.addEventListener("change",window.map.changeGuests),i.addEventListener("change",window.map.changeFeatures),window.pageState.ad.addEventListener("submit",(function(e){window.server.upload(new FormData(window.pageState.ad),window.popup.uploadSuccess,window.popup.uploadError),e.preventDefault()})),a.addEventListener("click",window.form.onResetButtonClick)})()})();